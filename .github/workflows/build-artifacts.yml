name: Weekly Release

on:
  schedule:
    - cron: '0 17 * * 5'
  workflow_dispatch:

jobs:
  release:
    name: Create Weekly Release
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Ensure full history is fetched

      - name: Use desired version of NodeJS
        uses: actions/setup-node@5b52f097d36d4b0b2f94ed6de710023fbb8b2236 # v3.1.0
        with:
          node-version-file: '.nvmrc'
          cache: npm

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'

      - name: Grant execute permissions for build script
        run: chmod +x ./bin/build-plugin-zip.sh

      - name: Generate plugin zip file
        run: ./bin/build-plugin-zip.sh -b

      - name: Get merged PRs
        id: changelog
        run: |
          echo "Fetching PRs merged into release branch..."
          PRS=$(git log --merges --pretty=format:"%h %s" | grep -Eo '#[0-9]+' | sort | uniq)
          echo "Found PRs: $PRS"
          echo "::set-output name=prs::$PRS"

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "v1.0.1"
          release_name: "Weekly Release $(date +'%Y-%m-%d')"
          body: |
            Changes in this Release
            - First Change
            - Second Change
          draft: false
          prerelease: true


      - name: Upload plugin zip to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./continuous-integrations.zip
          asset_name: continuous-integrations.zip
          asset_content_type: application/zip
